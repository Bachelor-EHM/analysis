---
title: "BA analysis test"
author: "Eva SH"
date: "10/14/2020"
output: html_document
---

Setup
```{r setup, include=FALSE}
#Load!
pacman::p_load(readr,tidyverse,dplyr,ggplot2,pastecs,ez,reshape2,stringr,lme4,stats,MuMIn,broom,emmeans,afex,lmerTest,scales,rstatix,ggpubr,magrittr,stats,plyr)
```

Loading and some extra wrangling
```{r}
###WE NEED TO FIND A SOLUTION WITH RED: IF STATEMENT FOR HUES BETWEEN 0 AND 20? But it works with the current data right now

#Load
Day2 <- read_csv("data_day_2_color.csv")
Day2 <- Day2 %>% select(-("Focal"))

#Exclude English (for now)
Day2 <- Day2 %>% filter(Language=="Danish")

#As factors
Day2$Condition <- as.factor(Day2$Condition)
Day2$Chain <- as.factor(Day2$Chain)
Day2$Color_label_source <- as.factor(Day2$Color_label_source)
Day2$Color_label_matched <- as.factor(Day2$Color_label_matched)

#Remove and order columns for overview
Day2 <- Day2 %>% select(-c("X1","Language","Lightness_source","Lighness_matched","Color_label_matched"))

col_order <- c("rt","Subject","Condition_label","Condition","Chain","Generation","Color_label_source","Saturation_source","Saturation_matched","Hue_source","Hue_matched")
Day2 <- Day2[, col_order]

#Add 360 when matched hue is between 0 and 20 (check if it works when we have data lower than 20)
Day2$Hue_matched <- case_when(Day2$Hue_matched < 21 ~ Day2$Hue_matched + 360,
                               Day2$Hue_matched > 21 ~ Day2$Hue_matched)

#Add column with the focal hue angle 
Day2$Focal_Hue <- Day2$Color_label_source
Day2$Focal_Hue <- revalue(Day2$Focal_Hue, c("seed græsgrøn" = "136.5","seed havblå" = "193.6", "seed mørk rosa" = "372.2", "seed sennepsgul" = "62.4"))
#As numeric
Day2$Focal_Hue <- as.numeric(paste(Day2$Focal_Hue))

#Add column with the seed hue angle 
Day2$Seed_Hue <- Day2$Color_label_source
Day2$Seed_Hue <- revalue(Day2$Seed_Hue, c("seed græsgrøn" = "117.98","seed havblå" = "179.34", "seed mørk rosa" = "327.55", "seed sennepsgul" = "49.85"))
#As numeric
Day2$Seed_Hue <- as.numeric(paste(Day2$Seed_Hue))

#Add column with difference between matched hue and focal:
Day2$Abs_Dif <- Day2$Focal_Hue-Day2$Hue_matched

#Ass column with relative difference between matched hue and focal:
Day2$Rel_Dif <- 100/(Day2$Focal_Hue-Day2$Seed_Hue)*Day2$Abs_Dif

```



Plots
```{r}
#Relevant plots: Development of each color in each chain in each condition. 
#Colors: 
red <- Day2 %>% filter(Color_label_source=="seed mørk rosa")
yellow <- Day2 %>% filter(Color_label_source=="seed sennepsgul")
green <- Day2 %>% filter(Color_label_source=="seed græsgrøn")
blue <- Day2 %>% filter(Color_label_source=="seed havblå")
#Chains 
chain0 <- Day2 %>% filter(Chain==0)
chain1 <- Day2 %>% filter(Chain==1)
chain2 <- Day2 %>% filter(Chain==2)
#Conditions
cond1 <- Day2 %>% filter(Condition==1)
cond2 <- Day2 %>% filter(Condition==2)

#Only for chain 0 beneath

#Hue
color_hue_line <- ggplot(chain0, aes(x = Generation, y = Rel_Dif, group = Color_label_source, color = Color_label_source))+
  geom_line(stat="summary") +
  expand_limits(y=0) +
  xlab("Generation") + 
  ylab("Relative difference %") +
  ggtitle("Plot") +
  facet_wrap(~ Condition)
color_hue_line

#Saturation
color_sat_line <- ggplot(chain0, aes(x = Generation, y = Saturation_matched, group = Color_label_source, color = Color_label_source))+
  geom_line(stat="summary") +
  expand_limits(y=0) +
  xlab("Generation") + 
  ylab("Relative difference %") +
  ggtitle("Plot") +
  facet_wrap(~ Condition)
color_sat_line

```

Modelling
```{r}
#Hue angle
#What is the matter with 0 or 1 in random effects? 
require(afex)
set_sum_contrasts()
m_hue_2 <- lmer(Rel_Dif ~ Condition + Generation + Color_label_source + (1 + Condition + Generation + Color_label_source | Chain/Subject), data = Day2, REML = F, control = lmerControl(
  optimizer = "nloptwrap",
  calc.derivs = F,
  optCtrl = list(
    ftol_abs = 1e-10,
    xtol_abs = 1e-10,
    maxeval = 10000
  )))
summary(mm2)


#Saturation
require(afex)
set_sum_contrasts()
m_sat_2 <- lmer(Saturation_matched ~ Condition + Generation + Color_label_source + (1 + Condition + Generation + Color_label_source | Chain/Subject), data = Day2, REML = F, control = lmerControl(
  optimizer = "nloptwrap",
  calc.derivs = F,
  optCtrl = list(
    ftol_abs = 1e-10,
    xtol_abs = 1e-10,
    maxeval = 10000
  )))
summary(m_sat_2)

```



















